name: Test Install/Uninstall

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Homebrew is installed
        run: |
          echo "ðŸº Checking Homebrew installation..."
          brew --version
          which brew

      - name: Install Copilot CLI (if not present)
        run: |
          echo "ðŸ“¦ Installing Copilot CLI..."
          if ! brew list --cask copilot-cli 2>/dev/null; then
            brew install --cask copilot-cli || echo "âš ï¸ Copilot CLI cask not available, skipping"
          else
            echo "âœ… Copilot CLI already installed"
          fi

      - name: Validate AppleScript syntax
        run: |
          echo "ðŸ” Validating AppleScript syntax..."
          osacompile -o /dev/null copilot_update_checker.scpt
          echo "âœ… AppleScript syntax is valid"

      - name: Validate plist syntax
        run: |
          echo "ðŸ” Validating plist syntax..."
          plutil -lint com.user.copilot-update-checker.plist
          echo "âœ… Plist syntax is valid"

      - name: Test install script
        run: |
          echo "ðŸš€ Running install script..."
          chmod +x install.sh
          ./install.sh
          echo "âœ… Install completed"

      - name: Verify installation files exist
        run: |
          echo "ðŸ” Verifying installed files..."
          
          # Check AppleScript
          if [[ -f ~/.local/bin/copilot_update_checker.scpt ]]; then
            echo "âœ… AppleScript installed at ~/.local/bin/copilot_update_checker.scpt"
            ls -la ~/.local/bin/copilot_update_checker.scpt
          else
            echo "âŒ AppleScript not found"
            exit 1
          fi
          
          # Check LaunchAgent
          if [[ -f ~/Library/LaunchAgents/com.user.copilot-update-checker.plist ]]; then
            echo "âœ… LaunchAgent installed at ~/Library/LaunchAgents/"
            ls -la ~/Library/LaunchAgents/com.user.copilot-update-checker.plist
          else
            echo "âŒ LaunchAgent plist not found"
            exit 1
          fi

      - name: Verify secure file permissions
        run: |
          echo "ðŸ” Checking file permissions..."
          
          # Check AppleScript permissions (should be 700)
          SCRIPT_PERMS=$(stat -f "%OLp" ~/.local/bin/copilot_update_checker.scpt)
          echo "AppleScript permissions: $SCRIPT_PERMS"
          if [[ "$SCRIPT_PERMS" == "700" ]]; then
            echo "âœ… AppleScript has secure permissions (700)"
          else
            echo "âš ï¸ AppleScript permissions are $SCRIPT_PERMS (expected 700)"
          fi

      - name: Verify LaunchAgent is loaded
        run: |
          echo "ðŸ” Checking LaunchAgent status..."
          if launchctl list | grep -q "com.user.copilot-update-checker"; then
            echo "âœ… LaunchAgent is loaded"
            launchctl list com.user.copilot-update-checker || true
          else
            echo "âš ï¸ LaunchAgent not loaded (may require GUI session)"
          fi

      - name: Test automation script execution
        run: |
          echo "ðŸ§ª Testing automation script..."
          # Run the script - it may fail if copilot-cli isn't installed, but should not crash
          osascript ~/.local/bin/copilot_update_checker.scpt || true
          echo "âœ… Script executed without crash"

      - name: Check log file creation
        run: |
          echo "ðŸ“‹ Checking log files..."
          
          # Check for secure log location
          if [[ -f ~/Library/Logs/copilot-update-checker.log ]]; then
            echo "âœ… Secure log file created at ~/Library/Logs/"
            echo "ðŸ“„ Log contents:"
            cat ~/Library/Logs/copilot-update-checker.log
          else
            echo "âš ï¸ Log file not found at secure location"
          fi
          
          # Verify no logs in insecure /tmp/ location
          if [[ -f /tmp/copilot-update-checker.log ]]; then
            echo "âš ï¸ WARNING: Found log in insecure /tmp/ location"
          else
            echo "âœ… No logs in insecure /tmp/ location"
          fi

      - name: Test uninstall script
        run: |
          echo "ðŸ—‘ï¸ Running uninstall script..."
          chmod +x uninstall.sh
          echo "n" | ./uninstall.sh  # Answer 'n' to keep logs
          echo "âœ… Uninstall completed"

      - name: Verify uninstallation
        run: |
          echo "ðŸ” Verifying uninstallation..."
          
          # Check AppleScript removed
          if [[ ! -f ~/.local/bin/copilot_update_checker.scpt ]]; then
            echo "âœ… AppleScript removed"
          else
            echo "âŒ AppleScript still exists"
            exit 1
          fi
          
          # Check LaunchAgent removed
          if [[ ! -f ~/Library/LaunchAgents/com.user.copilot-update-checker.plist ]]; then
            echo "âœ… LaunchAgent plist removed"
          else
            echo "âŒ LaunchAgent plist still exists"
            exit 1
          fi
          
          # Check LaunchAgent unloaded
          if ! launchctl list | grep -q "com.user.copilot-update-checker"; then
            echo "âœ… LaunchAgent unloaded"
          else
            echo "âš ï¸ LaunchAgent may still be loaded"
          fi

      - name: Test reinstall after uninstall
        run: |
          echo "ðŸ”„ Testing reinstall..."
          ./install.sh
          
          if [[ -f ~/.local/bin/copilot_update_checker.scpt ]] && \
             [[ -f ~/Library/LaunchAgents/com.user.copilot-update-checker.plist ]]; then
            echo "âœ… Reinstall successful"
          else
            echo "âŒ Reinstall failed"
            exit 1
          fi

      - name: Final cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          # Unload LaunchAgent if loaded
          launchctl unload ~/Library/LaunchAgents/com.user.copilot-update-checker.plist 2>/dev/null || true
          # Remove files
          rm -f ~/.local/bin/copilot_update_checker.scpt
          rm -f ~/Library/LaunchAgents/com.user.copilot-update-checker.plist
          rm -f ~/Library/Logs/copilot-update-checker.log
          rm -f ~/Library/Logs/copilot-update-checker.error.log
          echo "âœ… Cleanup complete"
